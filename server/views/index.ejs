<!DOCTYPE html>
<html>
<head>
	<title>Prynth</title>
	<link rel='stylesheet' href='/stylesheets/style.css' />

	<!--Jquery-->
	<script src="javascripts/jquery/jquery-3.2.1.min.js"></script>

	<!--socket.io-->
	<script src="javascripts/socket.io/socket.io.js"></script>

	<!--codemirror-->
	<script src="javascripts/codemirror/lib/codemirror.js"></script>

	<link rel="stylesheet" href="javascripts/codemirror/lib/codemirror.css">
	<link rel="stylesheet" href="javascripts/codemirror/theme/prynth-cm.css">

	<script src="javascripts/codemirror/mode/javascript/javascript.js"></script>
	<script src="javascripts/codemirror/addon/edit/matchbrackets.js"></script>
	<script src="javascripts/codemirror/addon/edit/closebrackets.js"></script>
	<script src="javascripts/codemirror/addon/comment/comment.js"></script>
	<script src="javascripts/codemirror/addon/selection/active-line.js"></script>

	<style type="text/css">
		.CodeMirror {width:100%; height:460px;}
	</style>

</head>

<body>
<div>
	<a href="http://prynth.github.io" target="_blank" style="text-decoration: none"><img src="/images/prynth_logo.png" style="width: 30px;"> <span style="font-size:2em;"> Prynth</span> </a>
	<!--<label id="heartLabel"></label>-->
</div>


<div style="width: 70vw; float: left" class="PrynthPanel">
	<form>
		<h2 class="PrynthPanelLabel">Editor</h2><span id="loadedFile" class="panel"></span><br>
		<textarea id="codeTextarea"><%=tempcode%></textarea>
		<button type="button" id="runButton">Run</button>
		<button type="button" id="killButton">Kill</button>
		<a href="/schelp/index.html" target="_blank"><button type="button">Help</button></a>
        <button type="button" id="restartSclangButton">Restart SC</button>

		<br>
		<br>

		<h2 class="PrynthPanelLabel">Post Window</h2>
		<textarea id="consoleTextarea" style="height: 120px;"></textarea>
		<br>
		<button type="button" id="clearConsoleButton">Clear</button>
	</form>
</div>

<div style="float: left; width: 220px">
	<div style="width: 200px;" class="PrynthPanel">
		<h2 class="PrynthPanelLabel">System Info</h2>
		Uptime: <span id="clock" class="panel"></span><br>
		Hostname: <span id="hostname" class="panel"></span><br>
		Ethernet IP: <span id="ethernetip" class="panel"></span><br>
		Wireless IP: <span id="wirelessip" class="panel"></span><br>
		CPU usage: <span id="cpu" class="panel"></span><br>
		Free memory: <span id="freemem" class="panel"></span><br>
		<form>
            <a href="/system" target="_blank"><button type="button">System</button></a>
			<button type="button" id="rebootButton">Reboot</button>
			<button type="button" id="shutdownButton">Shutdown</button>
		</form>
	</div>

	<div style="width: 200px;" class="PrynthPanel">
		<h2 class="PrynthPanelLabel">SC files</h2>
		<select id="supercolliderfiles" multiple style="width:200px; height:120px">
			<% for (var i = 0; i < supercolliderfiles.length; i++) { %>
			<option value="<%=i%>"><%=supercolliderfiles[i]%>
				<% } %>
		</select>
		<br>

		<button type="button" id="savescfilebutton">Save</button>
		<button type="button" id="loadscfilebutton">Load</button>
		<button type="button" id="deletescfilebutton">Delete</button>
	</div>

	<div style="width: 200px;" class="PrynthPanel">
		<h2 class="PrynthPanelLabel">Sound files</h2>
		<select id="soundfiles" multiple style="width: 200px; height: 120px">
			<% for (var i = 0; i < soundfiles.length; i++) { %>
			<option value="<%=i%>"><%=soundfiles[i]%>
				<% } %>
		</select>
		<br>
		<form id = "soundfileupload" enctype="multipart/form-data" method="post" action="/soundfileupload">
			<label class="myLabel">
				<input type="file" style="visibility: hidden" name="filename" multiple onchange="javascript:this.form.submit();"/>
				<span>Upload</span>
			</label>
			<button type="button" id="deletesoundfilebutton">Delete</button>
		</form>
	</div>
</div>


<!--<div style="width: 100vw; float: left">-->
	<!--<br>-->
	<!--<br>-->
	<!--<footer>-->
        <!--<% include footer %>-->
	<!--</footer>-->
<!--</div>-->


<script>

    //var CodeMirror = require('/codemirror');
    //require('codemirror/mode/javascript/javascript.js');


	var editor = CodeMirror.fromTextArea(document.getElementById("codeTextarea"), {
		lineNumbers: true,
		mode: "javascript",
		matchBrackets: true,
		autofocus: true,
		styleActiveLine: true,
		smartIndent: false,
		indentWithTabs: true,
		lineWrapping: true,
		theme: "prynth-cm",
		autoCloseBrackets: true,
		extraKeys: {"Ctrl-Q": "toggleComment"}
	});

    //editor.on('mousedown', function() {

	var selFlag = 0;

    editor.on("keypress", function(editor) {
        if (selFlag===1){
            //alert(String(editor.getCursor().line));
		}

    });

    editor.on("cursorActivity", function(editor) {
        //alert('Click');
        console.log("lineNow = "+String(editor.getLine(editor.getCursor().line)));

		//-------------

        var openBracket = "(";
        var closeBracket = ")";
        var curLine = editor.getCursor().line;
        var lineNow = curLine;
        var curLineContent;
        var checkOpen=1;
        var checkClose=1;
        var bracketCount = 0;

        curLineContent = String(editor.getLine(curLine));
        checkClose = curLineContent.localeCompare(closeBracket);
        if (checkClose===0){
            //alert('found matching bracket');
			bracketCount += 1;
            while (lineNow > 0){
                lineNow = lineNow - 1;
                curLineContent = String(editor.getLine(lineNow));
                checkOpen = curLineContent.localeCompare(openBracket);
                checkClose = curLineContent.localeCompare(closeBracket);
                if (checkOpen===0){
                    bracketCount -= 1;
                }
                else if (checkClose===0){
                    bracketCount += 1;
                }
                if (bracketCount===0) break;
            }
            var open = {line: lineNow, ch: 0 };
            var close = {line: curLine, ch: 1 };
            //editor.setSelection(open, close);
			for (var i = lineNow; i<curLine; i++)
			{
                editor.addLineClass(i, 'background', 'CodeMirror-activeline-background');
			}

            selFlag = 1;

            //editor.setCursor({line: close+1, ch: 0});
            //alert("lineNow = "+String(editor.getCursor().line));
        }
        else
		{
            for (var i = 0; i<lineNow; i++)
            {
                editor.removeLineClass(i, 'background', 'CodeMirror-activeline-background');
            }
		}
    });

	//editor.setSize(width: "400px", height: "600px");

	var curWord = "";



    editor.on('cursorActivity', function() {
        var A1 = editor.getCursor().line;
        var A2 = editor.getCursor().ch;

        var B1 = editor.findWordAt({line: A1, ch: A2}).anchor.ch;
        var B2 = editor.findWordAt({line: A1, ch: A2}).head.ch;

		curWord = editor.getRange({line: A1,ch: B1}, {line: A1,ch: B2});
		console.log(curWord);
        //console.log(editor.getRange({line: A1,ch: B1}, {line: A1,ch: B2}));
    });

	//post for run button
	function interpret(data) {
		$.ajax({method: "POST", url: '/interpret', data: {code: data}});
	}

	function runtemp(data) {
		$.ajax({method: "POST", url: '/runtemp', data: {code: data}});
//			$.ajax({method: "POST", url: '/runtemp'});
	}

	function detectOS() {
		var OSName='Unknown OS';
		if (navigator.appVersion.indexOf("Win")!== -1) OSName="Windows";
		if (navigator.appVersion.indexOf("Mac")!== -1) OSName="MacOS";
		if (navigator.appVersion.indexOf("X11")!== -1) OSName="UNIX";
		if (navigator.appVersion.indexOf("Linux")!== -1) OSName="Linux";
		return OSName;
	}

	function setExtrakeys() {

		var OS = detectOS();

//			var modifierKey = '';

//			if(OS === 'MacOS'){modifierKey = 'Cmd'} else {modifierKey = 'Ctrl'};
//
//			var interpret = modifierKey + '-Enter';
//			var kill = modifierKey + '-.';

		if (OS === 'MacOS'){
			editor.setOption("extraKeys", {
				'Cmd-Enter' : function () {
					let selection = editor.getSelection();
					if (selection !== '') {
						interpret(selection);
					} else {

						var openBracket = "(";
                        var closeBracket = ")";
                        var curLine = editor.getCursor().line;
                        var lineNow = curLine;
                        var lineRem = lineNow;
                        var codeBracket = "";
                        var curLineContent;
						var checkOpen=1;
                        var checkClose=1;
						var countBrackets=0;
                        var countBracketsClose=0;
						var bracketFound = 0;
                        // editor.setValue(String(editor.getLine(lineNow-1)));

						//alert(String(lineNow));
                        // editor.setValue(String(editor.getLine(lineNow-1).localeCompare(openBracket)));
						while (lineNow > 0){
							lineNow = lineNow - 1;
							curLineContent = String(editor.getLine(lineNow));

                            checkClose = curLineContent.localeCompare(closeBracket);
                            if (checkClose===0){
                                countBracketsClose += 1;
                            }

                            checkOpen = curLineContent.localeCompare(openBracket);
							if (checkOpen===0){
							    bracketFound = 1;
							    if (countBracketsClose === 0) {
                                    countBrackets += 1;
                                    lineRem = lineNow + 1;
								}
								else{
                                    countBracketsClose -= 1;
                                }
							}


                        }
                        // editor.setValue(String(lineRem));
						lineNow = lineRem;
						if (bracketFound!==0 && countBrackets>0) {
                            while (countBrackets !== 0) {
                                checkClose = String(editor.getLine(lineNow)).localeCompare(closeBracket)
                                if (checkClose === 0 && lineNow>=curLine) {
                                    countBrackets -= 1;
                                }
                                checkOpen = String(editor.getLine(lineNow)).localeCompare(openBracket)
                                if (checkOpen === 0 && lineNow>=curLine) {
                                    countBrackets += 1;
                                }
                                if (countBrackets===0) break;

                                codeBracket += String(editor.getLine(lineNow));
                                console.log(String(lineNow) + " = " + codeBracket);
                                lineNow += 1;

                            }
                            //editor.setValue(String(codeBracket));
							//alert(codeBracket);
                            interpret(codeBracket);
                        }
                        else{
                            interpret(editor.getLine(editor.getCursor().line));
						}

					}
				},
				'Cmd-.' : function () {
					interpret('s.freeAll;');
					// alert("dot!");
				},

                'Cmd-;' : function () {
				    var helpLink = "/schelp/Classes/" + curWord + ".html";
                    //var helpLink = "/schelp/Search.html";
                    //document.getElementById('search_input').value = curWord;

                    //window.open("/Search.html");
                    window.open(helpLink);

                    // var http = require('http');
                    // var fs = require('fs');
                    //
                    // const PORT=8080;

                    // fs.readFile('/schelp/Classes/SinOsc.html', function (err, html) {
                    //
                    //     if (err) throw err;
                    //
                    //     http.createServer(function(request, response) {
                    //         response.writeHeader(200, {"Content-Type": "text/html"});
                    //         response.write(html);
                    //         response.end();
                    //     }).listen(PORT);
                    // });

                },

                'Cmd-/' : "toggleComment"
			});
		} else {
			editor.setOption("extraKeys", {
				'Ctrl-Enter' : function () {
					let selection = editor.getSelection();
					if (selection !== '') {
						interpret(selection);
					} else {
						interpret(editor.getLine(editor.getCursor().line));
					}
				},
				'Ctrl-.' : function () {
					interpret('s.freeAll;');
				},
				'Ctrl-/' : "toggleComment"
			});

		}
	}


	$(document).ready(function () {

		let socket = io.connect();

		let $runButton = $('#runButton');
		let $killButton = $('#killButton');
		let $clearConsoleButton = $('#clearConsoleButton');

		let $loadscfilebutton = $('#loadscfilebutton');
		let $savescfilebutton = $('#savescfilebutton');
		let $deletescfilebutton = $('#deletescfilebutton');
		let $deletesoundfilebutton = $('#deletesoundfilebutton');

		let $consoleTextarea = $('#consoleTextarea');
		let $supercolliderfiles = $('#supercolliderfiles');
		let $soundfiles = $('#soundfiles');

//		let $heartlabel = $('#heartLabel');
//		let $tempheartlabel = "";

		let $clock = $('#clock');
		let $hostname = $('#hostname');
		let $ethernetip = $('#ethernetip');
		let $wirelessip = $('#wirelessip');
		let $cpu = $('#cpu');
		let $freemem = $('#freemem');

		let $rebootSubmit = $('#rebootButton');
		let $shutdownSubmit = $('#shutdownButton');
		let $restartSclangSubmit = $('#restartSclangButton');
		let $loadedFile = $('#loadedFile');
		var fileLoaded;


        setExtrakeys();

		$rebootSubmit.click(function () {
			$.ajax({method: "POST", url: '/reboot'});
			alert('Rebooting...');
		});
		$shutdownSubmit.click(function () {
			$.ajax({method: "POST", url: '/shutdown'});
			alert('Shutting down...')
		});
		$restartSclangSubmit.click(function () {
			$.ajax({method: "POST", url: '/restartsclang'});
//			alert('Shutting down...')
		});

		//run all code in editor window
		$runButton.click(function () {runtemp(editor.getValue());});
		//kill all nodes on server
		$killButton.click(function () {interpret('s.freeAll;')});

		//clear console textarea
		$clearConsoleButton.click(function () {$consoleTextarea.html('');});

		//file management buttons
		$loadscfilebutton.click(function () {
			let temp = $supercolliderfiles.val();
			let fileindex =  JSON.stringify(temp);
			$.ajax({method: "POST", url: '/supercolliderfiles',data: {action: 'load', fileindex: fileindex}});
		})

		$savescfilebutton.click(function () {
			//here we need to implement save function to create new scd files
			let filename=prompt('Enter new file name', fileLoaded);
			if(filename) {
				$.ajax({method: "POST", url: '/supercolliderfiles',data: {action: 'save', filename: filename, code: editor.getValue()}});
			}

		})

		$deletescfilebutton.click(function () {
			let temp = $supercolliderfiles.val();
			let fileindex =  JSON.stringify(temp);
			$.ajax({method: "POST", url: '/supercolliderfiles',data: {action: 'delete', fileindex: fileindex}
			});
		})


		$deletesoundfilebutton.click(function () {
			let temp = $soundfiles.val();
			let fileindex =  JSON.stringify(temp);
			$.ajax({method: "POST", url: '/soundfiles',data: {action: 'delete', fileindex: fileindex}
			});
		})

		//socket actions
		socket.on('toeditor', function (data) {
            editor.setValue(data);
		});

        socket.on('toprompt', function (data) {
            fileLoaded = String(data);
			console.log(data);
			$loadedFile.html(fileLoaded);
        });

		socket.on('toconsole', function (data) {
		    // console.log("data-----------"+data);

            // console.log("length is ==== "+String( $consoleTextarea.val().length));
            $consoleTextarea.append(data);
            $consoleTextarea.scrollTop($consoleTextarea[0].scrollHeight);

            var maxConsoleChar = 1000;
            var sliceChar = -100;
            var tempbuf;
            if ($consoleTextarea.val().length >= maxConsoleChar){
                //console.log("INSIDE SLICE");
                tempBuf = $consoleTextarea.val().slice(sliceChar);
                $consoleTextarea.html(tempBuf);
            }
		});

		socket.on('tosupercolliderfiles', function (data) {
			$supercolliderfiles[0].options.length = 0;
			$.each(data, function(key, value) {
				$supercolliderfiles
					.append($('<option>', { value : key })
						.text(value));
			});
		});

		socket.on('tosoundfiles', function (data) {
			$soundfiles[0].options.length = 0;
			$.each(data, function(key, value) {
				$soundfiles
					.append($('<option>', { value : key })
						.text(value));
			});
		});

		//receive systeminfo
		socket.on('systeminfo', function (data) {
//				if ($heartlabel.html() === '\u2665') {$heartlabel.html('\u2764');} else {$heartlabel.html('\u2665');}
				$clock.html(data.tick +' s');
				$hostname.html(data.hostname);
				$ethernetip.html(data.ethernetip);
				$wirelessip.html(data.wirelessip);
				$cpu.html(data.cpu + ' %');
				$freemem.html(data.freemem + ' Mb' );
		})


		//close socket when closing client
		$(window).on('beforeunload', function(){
			socket.close();
		});
	})
</script>

</body>
</html>
